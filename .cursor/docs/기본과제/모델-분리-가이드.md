# Models 폴더 분리 가이드

이 문서는 `src/basic/models/` 폴더에 들어가야 하는 비즈니스 로직(순수함수)을 정리합니다.

---

## 📋 모델로 들어가야 하는 것들의 기준

### ✅ 모델로 들어가야 하는 것 (순수함수)

1. **외부 상태에 의존하지 않음**
   - 컴포넌트의 state를 직접 참조하지 않음
   - 모든 필요한 데이터를 파라미터로 받음

2. **부수 효과(Side Effect) 없음**
   - `setState` 사용 안 함
   - `localStorage` 접근 안 함
   - `console.log` 등 출력 안 함
   - API 호출 안 함

3. **같은 입력에 항상 같은 출력**
   - 랜덤 값 사용 안 함
   - 현재 시간 사용 안 함
   - 외부 변수 참조 안 함

4. **불변성 유지**
   - 기존 배열/객체를 수정하지 않음
   - 새로운 배열/객체를 반환

---

## 🛒 Cart 엔티티 관련 함수들 (`models/cart.ts`)

### 1. `getMaxApplicableDiscount` - 적용 가능한 최대 할인율 계산

**현재 코드 위치**: `src/origin/App.tsx` (line 147-163)

**현재 문제점**:
- `cart`에 의존 (외부 상태)
- `BULK_PURCHASE_QUANTITY`, `BULK_PURCHASE_ADDITIONAL_DISCOUNT`, `MAX_DISCOUNT_RATE` 하드코딩

**변환 후**:
```typescript
/**
 * 적용 가능한 최대 할인율 계산
 * @param item 장바구니 아이템
 * @param cart 전체 장바구니 (대량 구매 확인용)
 * @returns 최대 할인율 (0 ~ 1)
 */
export const getMaxApplicableDiscount = (
  item: CartItem,
  cart: CartItem[]
): number => {
  const { discounts } = item.product;
  const { quantity } = item;
  
  // 기본 할인율 계산
  const baseDiscount = discounts.reduce((maxDiscount, discount) => {
    return quantity >= discount.quantity && discount.rate > maxDiscount 
      ? discount.rate 
      : maxDiscount;
  }, 0);
  
  // 대량 구매 추가 할인 확인
  const hasBulkPurchase = cart.some(
    cartItem => cartItem.quantity >= BULK_PURCHASE_QUANTITY
  );
  
  if (hasBulkPurchase) {
    return Math.min(
      baseDiscount + BULK_PURCHASE_ADDITIONAL_DISCOUNT,
      MAX_DISCOUNT_RATE
    );
  }
  
  return baseDiscount;
};
```

**비즈니스 규칙**:
- 상품의 할인 정책 중 수량 조건을 만족하는 최대 할인율 찾기
- 대량 구매(10개 이상) 시 추가 5% 할인
- 최대 할인율은 50%로 제한

---

### 2. `calculateItemTotal` - 개별 아이템의 할인 적용 후 총액 계산

**현재 코드 위치**: `src/origin/App.tsx` (line 165-171)

**현재 문제점**:
- `getMaxApplicableDiscount`를 사용하지만 `cart`에 의존
- `item`만 받아서 계산하려고 하지만 `cart`가 필요함

**변환 후**:
```typescript
/**
 * 개별 아이템의 할인 적용 후 총액 계산
 * @param item 장바구니 아이템
 * @param cart 전체 장바구니 (대량 구매 확인용)
 * @returns 할인 적용 후 총액
 */
export const calculateItemTotal = (
  item: CartItem,
  cart: CartItem[]
): number => {
  const { price } = item.product;
  const { quantity } = item;
  const discount = getMaxApplicableDiscount(item, cart);
  
  return Math.round(price * quantity * (1 - discount));
};
```

**비즈니스 규칙**:
- 상품 가격 × 수량 × (1 - 할인율)
- 소수점 반올림

---

### 3. `calculateCartTotal` - 장바구니 총액 계산

**현재 코드 위치**: `src/origin/App.tsx` (line 173-198)

**현재 문제점**:
- `cart`, `selectedCoupon`에 의존 (외부 상태)
- `calculateItemTotal`을 사용하지만 `cart`를 전달하지 않음

**변환 후**:
```typescript
/**
 * 장바구니 총액 계산 (할인 전/후)
 * @param cart 장바구니 아이템 배열
 * @param selectedCoupon 선택된 쿠폰 (null 가능)
 * @returns 할인 전 총액과 할인 후 총액
 */
export const calculateCartTotal = (
  cart: CartItem[],
  selectedCoupon: Coupon | null
): {
  totalBeforeDiscount: number;
  totalAfterDiscount: number;
} => {
  let totalBeforeDiscount = 0;
  let totalAfterDiscount = 0;

  cart.forEach(item => {
    const itemPrice = item.product.price * item.quantity;
    totalBeforeDiscount += itemPrice;
    totalAfterDiscount += calculateItemTotal(item, cart);
  });

  // 쿠폰 적용
  if (selectedCoupon) {
    if (selectedCoupon.discountType === 'amount') {
      totalAfterDiscount = Math.max(0, totalAfterDiscount - selectedCoupon.discountValue);
    } else {
      totalAfterDiscount = Math.round(
        totalAfterDiscount * (1 - selectedCoupon.discountValue / 100)
      );
    }
  }

  return {
    totalBeforeDiscount: Math.round(totalBeforeDiscount),
    totalAfterDiscount: Math.round(totalAfterDiscount)
  };
};
```

**비즈니스 규칙**:
- 할인 전 총액: 모든 아이템의 (가격 × 수량) 합계
- 할인 후 총액: 각 아이템의 할인 적용 후 합계
- 쿠폰 적용:
  - `amount` 타입: 총액에서 할인 금액 차감
  - `percentage` 타입: 총액에 할인율 적용
- 최소 금액은 0원

---

### 4. `getRemainingStock` - 남은 재고 계산

**현재 코드 위치**: `src/origin/App.tsx` (line 200-205)

**현재 문제점**:
- `cart`에 의존 (외부 상태)

**변환 후**:
```typescript
/**
 * 남은 재고 계산
 * @param product 상품
 * @param cart 장바구니 (현재 주문 수량 확인용)
 * @returns 남은 재고 수량
 */
export const getRemainingStock = (
  product: Product,
  cart: CartItem[]
): number => {
  const cartItem = cart.find(item => item.product.id === product.id);
  const remaining = product.stock - (cartItem?.quantity || 0);
  return remaining;
};
```

**비즈니스 규칙**:
- 상품 재고 - 장바구니에 담긴 수량 = 남은 재고

---

### 5. `addItemToCart` - 장바구니에 상품 추가 (순수함수 버전)

**현재 코드 위치**: `src/origin/App.tsx` (line 247-276)

**현재 문제점**:
- `setCart` 사용 (부수 효과)
- `addNotification` 사용 (부수 효과)
- `getRemainingStock` 사용하지만 `cart`에 의존

**변환 후**:
```typescript
/**
 * 장바구니에 상품 추가 (순수함수)
 * @param cart 현재 장바구니
 * @param product 추가할 상품
 * @returns 새로운 장바구니 배열
 */
export const addItemToCart = (
  cart: CartItem[],
  product: Product
): CartItem[] => {
  const existingItem = cart.find(item => item.product.id === product.id);
  
  if (existingItem) {
    // 이미 장바구니에 있으면 수량 증가
    return cart.map(item =>
      item.product.id === product.id
        ? { ...item, quantity: item.quantity + 1 }
        : item
    );
  }
  
  // 장바구니에 없으면 새로 추가
  return [...cart, { product, quantity: 1 }];
};
```

**비즈니스 규칙**:
- 이미 장바구니에 있으면 수량 +1
- 없으면 새로 추가 (수량 1)

**주의사항**:
- 재고 확인은 Hook에서 수행 (이 함수는 순수함수로만 유지)
- 알림 표시는 Hook에서 수행

---

### 6. `removeItemFromCart` - 장바구니에서 상품 제거 (순수함수 버전)

**현재 코드 위치**: `src/origin/App.tsx` (line 278-280)

**현재 문제점**:
- `setCart` 사용 (부수 효과)

**변환 후**:
```typescript
/**
 * 장바구니에서 상품 제거 (순수함수)
 * @param cart 현재 장바구니
 * @param productId 제거할 상품 ID
 * @returns 새로운 장바구니 배열
 */
export const removeItemFromCart = (
  cart: CartItem[],
  productId: string
): CartItem[] => {
  return cart.filter(item => item.product.id !== productId);
};
```

**비즈니스 규칙**:
- 해당 상품 ID를 가진 아이템 제거

---

### 7. `updateCartItemQuantity` - 장바구니 아이템 수량 변경 (순수함수 버전)

**현재 코드 위치**: `src/origin/App.tsx` (line 282-304)

**현재 문제점**:
- `setCart` 사용 (부수 효과)
- `addNotification` 사용 (부수 효과)
- `products`에 의존

**변환 후**:
```typescript
/**
 * 장바구니 아이템 수량 변경 (순수함수)
 * @param cart 현재 장바구니
 * @param productId 변경할 상품 ID
 * @param quantity 새로운 수량
 * @returns 새로운 장바구니 배열
 */
export const updateCartItemQuantity = (
  cart: CartItem[],
  productId: string,
  quantity: number
): CartItem[] => {
  if (quantity <= 0) {
    // 수량이 0 이하면 제거
    return removeItemFromCart(cart, productId);
  }
  
  return cart.map(item =>
    item.product.id === productId
      ? { ...item, quantity }
      : item
  );
};
```

**비즈니스 규칙**:
- 수량이 0 이하면 아이템 제거
- 그 외에는 수량 업데이트

**주의사항**:
- 재고 확인은 Hook에서 수행
- 알림 표시는 Hook에서 수행

---

## 📦 Product 엔티티 관련 함수들 (`models/product.ts`)

### 8. `filterProducts` - 상품 검색/필터링

**현재 코드 위치**: `src/origin/App.tsx` (line 368-373)

**현재 문제점**:
- `products`, `debouncedSearchTerm`에 의존 (외부 상태)

**변환 후**:
```typescript
/**
 * 상품 검색/필터링
 * @param products 상품 배열
 * @param searchTerm 검색어
 * @returns 필터링된 상품 배열
 */
export const filterProducts = (
  products: Product[],
  searchTerm: string
): Product[] => {
  if (!searchTerm.trim()) {
    return products;
  }
  
  const lowerSearchTerm = searchTerm.toLowerCase();
  
  return products.filter(product =>
    product.name.toLowerCase().includes(lowerSearchTerm) ||
    (product.description && product.description.toLowerCase().includes(lowerSearchTerm))
  );
};
```

**비즈니스 규칙**:
- 검색어가 없으면 모든 상품 반환
- 상품명 또는 설명에 검색어가 포함된 상품만 반환
- 대소문자 구분 없음

---

### 9. `getProductById` - ID로 상품 찾기 (선택사항)

**필요시 추가**:
```typescript
/**
 * ID로 상품 찾기
 * @param products 상품 배열
 * @param id 상품 ID
 * @returns 찾은 상품 또는 undefined
 */
export const getProductById = (
  products: Product[],
  id: string
): Product | undefined => {
  return products.find(product => product.id === id);
};
```

---

## 🎫 Coupon 엔티티 관련 함수들 (`models/coupon.ts`)

### 10. `applyCouponToTotal` - 쿠폰을 총액에 적용 (순수함수 버전)

**현재 코드 위치**: `src/origin/App.tsx` (line 186-192)

**변환 후**:
```typescript
/**
 * 쿠폰을 총액에 적용
 * @param total 할인 적용 전 총액
 * @param coupon 적용할 쿠폰
 * @returns 쿠폰 적용 후 총액
 */
export const applyCouponToTotal = (
  total: number,
  coupon: Coupon
): number => {
  if (coupon.discountType === 'amount') {
    return Math.max(0, total - coupon.discountValue);
  } else {
    return Math.round(total * (1 - coupon.discountValue / 100));
  }
};
```

**비즈니스 규칙**:
- `amount` 타입: 총액에서 할인 금액 차감
- `percentage` 타입: 총액에 할인율 적용
- 최소 금액은 0원

---

### 11. `validateCoupon` - 쿠폰 사용 가능 여부 검증 (선택사항)

**필요시 추가**:
```typescript
/**
 * 쿠폰 사용 가능 여부 검증
 * @param total 현재 총액
 * @param coupon 검증할 쿠폰
 * @returns 사용 가능 여부
 */
export const validateCoupon = (
  total: number,
  coupon: Coupon
): boolean => {
  if (coupon.discountType === 'percentage') {
    return total >= MIN_ORDER_AMOUNT_FOR_PERCENTAGE_COUPON;
  }
  return true;
};
```

**비즈니스 규칙**:
- `percentage` 타입 쿠폰은 최소 주문 금액 이상일 때만 사용 가능
- `amount` 타입 쿠폰은 항상 사용 가능

---

## ❌ 모델로 들어가면 안 되는 것들

### UI 관련 함수들

1. **`formatPrice`**
   - 이유: `isAdmin`에 의존 (UI 상태)
   - 위치: 컴포넌트 또는 utils/formatters.ts (범용 함수)

2. **`addNotification`**
   - 이유: `setNotifications` 사용 (부수 효과)
   - 위치: Hook 또는 컴포넌트

### 액션 함수들 (Hook으로 이동)

1. **`addToCart`** (현재 버전)
   - 이유: `setCart`, `addNotification` 사용
   - 위치: `hooks/useCart.ts`

2. **`removeFromCart`** (현재 버전)
   - 이유: `setCart` 사용
   - 위치: `hooks/useCart.ts`

3. **`updateQuantity`** (현재 버전)
   - 이유: `setCart`, `addNotification` 사용
   - 위치: `hooks/useCart.ts`

4. **`applyCoupon`** (현재 버전)
   - 이유: `setSelectedCoupon`, `addNotification` 사용
   - 위치: `hooks/useCart.ts`

5. **`completeOrder`**
   - 이유: `setCart`, `setSelectedCoupon`, `addNotification` 사용
   - 위치: `hooks/useCart.ts`

6. **`addProduct`**, **`updateProduct`**, **`deleteProduct`**
   - 이유: `setProducts`, `addNotification` 사용
   - 위치: `hooks/useProducts.ts`

7. **`addCoupon`**, **`deleteCoupon`**
   - 이유: `setCoupons`, `setSelectedCoupon`, `addNotification` 사용
   - 위치: `hooks/useCoupons.ts`

---

## 📁 파일 구조

```
src/basic/models/
├── cart.ts          # Cart 엔티티 관련 순수함수
├── product.ts       # Product 엔티티 관련 순수함수
├── coupon.ts        # Coupon 엔티티 관련 순수함수
└── discount.ts      # Discount 타입 정의 (필요시)
```

---

## ✅ 체크리스트

### Cart 관련 함수들
- [ ] `getMaxApplicableDiscount` - 할인율 계산
- [ ] `calculateItemTotal` - 개별 아이템 총액
- [ ] `calculateCartTotal` - 장바구니 총액
- [ ] `getRemainingStock` - 남은 재고
- [ ] `addItemToCart` - 상품 추가 (순수함수 버전)
- [ ] `removeItemFromCart` - 상품 제거 (순수함수 버전)
- [ ] `updateCartItemQuantity` - 수량 변경 (순수함수 버전)

### Product 관련 함수들
- [ ] `filterProducts` - 상품 필터링
- [ ] `getProductById` - ID로 상품 찾기 (선택사항)

### Coupon 관련 함수들
- [ ] `applyCouponToTotal` - 쿠폰 적용 (순수함수 버전)
- [ ] `validateCoupon` - 쿠폰 검증 (선택사항)

### 각 함수의 순수함수 확인
- [ ] 외부 상태에 의존하지 않음
- [ ] 모든 데이터를 파라미터로 받음
- [ ] 부수 효과 없음
- [ ] 불변성 유지 (새 배열/객체 반환)
- [ ] constants에서 비즈니스 규칙 가져옴

---

## 💡 구현 팁

1. **순서대로 구현**: 의존성이 있는 함수부터 구현
   - `getMaxApplicableDiscount` → `calculateItemTotal` → `calculateCartTotal`

2. **테스트 작성**: 각 함수를 테스트하기 쉬운 순수함수로 만들기

3. **타입 명확히**: 모든 파라미터와 반환값에 타입 지정

4. **JSDoc 주석**: 각 함수의 역할과 파라미터 설명

5. **비즈니스 규칙**: constants에서 상수 가져오기

---

## 📚 참고

- `.cursor/docs/리팩토링-실행순서.md`: 2단계 Models 계층 구현
- `.cursor/docs/학습방법.md`: 순수함수 작성 방법
- `src/origin/App.tsx`: 원본 코드 참고

---

**마지막 업데이트**: 2025-12-01

